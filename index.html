<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Qu·∫£n Tr·ªã</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* CSS cho n√∫t In (gi·ªØ nguy√™n) */
        .btn-print {
            padding: 10px 20px;
            background-color: #ffc107;
            color: #333;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            margin-bottom: 20px;
        }
        .btn-print:hover {
            background-color: #e0a800;
        }
        
        /* CSS cho b·∫£n in (gi·ªØ nguy√™n) */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-content, .printable-content * {
                visibility: visible;
            }
            .printable-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
            /* (M·ªöI) ·∫®n header v√† c√°c section kh√°c khi in */
            .header, #login-section, #dashboard-section, .modal {
                display: none !important;
            }
            
            /* (M·ªöI) Style ri√™ng cho In H√≥a ƒê∆°n */
            #invoice-modal-content {
                 visibility: visible !important;
                 box-shadow: none;
                 border: none;
                 margin: 0;
                 padding: 0;
                 max-width: 100%;
            }
        }
    </style>
</head>
<body>

    <div id="dashboard-section">
        
        <div class="header no-print">
            <div class="header-content">
                <div class="user-info">
                    Ch√†o m·ª´ng, <strong id="user-name"></strong>! 
                    (<span id="user-role"></span>)
                </div>
                <button id="logout-btn" class="btn-logout">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>

        <div class="admin-container">
            <h1>H·ªá th·ªëng</h1>

            <section id="revenue-section" class="revenue-section">
                <h2>üìà Qu·∫£n L√Ω Doanh Thu</h2>
                <div class="no-print">
                    <p>Doanh thu ƒë∆∞·ª£c t√≠nh t·ª´ c√°c ƒë∆°n h√†ng c√≥ tr·∫°ng th√°i "Ho√†n th√†nh".</p>
                    <button id="print-revenue-btn" class="btn-print">In B√°o C√°o Doanh Thu</button>
                </div>
                
                <div id="revenue-message-container" class="message"></div>
                
                <div class="printable-content">
                    <h3 style="text-align: center;">B√ÅO C√ÅO DOANH THU THEO NG√ÄY</h3>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Ng√†y</th>
                                <th>T·ªïng Doanh Thu (VNƒê)</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-list-body"></tbody>
                        <tfoot>
                            <tr>
                                <td style="font-weight: bold;">T·ªîNG C·ªòNG</td>
                                <td id="total-revenue" style="font-weight: bold;">0 ƒë</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
            
            <hr id="divider-admin" class="no-print" style="margin: 40px 0; border: 1px solid #ddd;">

            <section id="employee-section" class="employee-section no-print">
                <h2>üë§ Qu·∫£n L√Ω Nh√¢n Vi√™n</h2>
                <div id="employee-message-container" class="message"></div>
                <form id="add-employee-form" class="add-form">
                    <h3>Th√™m Nh√¢n Vi√™n M·ªõi</h3>
                    <div class="form-group">
                        <label for="hoTen">H·ªç v√† T√™n:</label>
                        <input type="text" id="hoTen" name="hoTen" required>
                    </div>
                    <div class="form-group">
                        <label for="tenDangNhapNV">T√™n ƒêƒÉng Nh·∫≠p:</label>
                        <input type="text" id="tenDangNhapNV" name="tenDangNhap" required>
                    </div>
                    <div class="form-group">
                        <label for="matKhauNV">M·∫≠t Kh·∫©u:</label>
                        <input type="password" id="matKhauNV" name="matKhau" required>
                    </div>
                    <button type="submit" class="btn-submit">Th√™m Nh√¢n Vi√™n</button>
                </form>

                <h3>üë• Danh S√°ch Nh√¢n Vi√™n</h3>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>M√£ Ng∆∞·ªùi D√πng</th>
                            <th>H·ªç v√† T√™n</th>
                            <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="employee-list-body"></tbody>
                </table>
            </section>

            <section id="order-section" class="order-section no-print">
                <h2>üì¶ Qu·∫£n L√Ω ƒê∆°n H√†ng</h2>
                <div id="order-message-container" class="message"></div>
                <h3>Danh S√°ch ƒê∆°n H√†ng</h3>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>M√£ ƒêH</th>
                            <th>Ng√†y ƒê·∫∑t</th>
                            <th>Kh√°ch H√†ng</th>
                            <th>T·ªïng Ti·ªÅn</th>
                            <th>Tr·∫°ng Th√°i</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="order-list-body"></tbody>
                </table>
            </section>

            <hr id="divider-staff-1" class="no-print" style="margin: 40px 0; border: 1px solid #ddd;">

            <section id="product-section" class="product-section no-print">
                <h2>üëï Qu·∫£n L√Ω S·∫£n Ph·∫©m</h2>
                <div id="product-message-container" class="message"></div>
                
                <form id="add-product-form" class="add-form">
                    <h3>Th√™m S·∫£n Ph·∫©m M·ªõi</h3>
                    <div class="form-group">
                        <label for="tenSanPham">T√™n S·∫£n Ph·∫©m:</label>
                        <input type="text" id="tenSanPham" name="tenSanPham" required>
                    </div>
                    <div class="form-group">
                        <label for="gia">Gi√° (VNƒê):</label>
                        <input type="number" id="gia" name="gia" required>
                    </div>
                    <div class="form-group">
                        <label for="maDanhMuc">Danh M·ª•c:</label>
                        <select id="maDanhMuc" name="maDanhMuc" required>
                            <option value="">-- ƒêang t·∫£i danh m·ª•c... --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="hinhAnhURL">Link H√¨nh ·∫¢nh (URL):</label>
                        <input type="text" id="hinhAnhURL" name="hinhAnhURL" placeholder="https://...">
                    </div>
                    <div class="form-group">
                        <label for="moTa">M√¥ T·∫£:</label>
                        <textarea id="moTa" name="moTa" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn-submit">Th√™m S·∫£n Ph·∫©m</button>
                </form>

                <h3>Danh S√°ch S·∫£n Ph·∫©m</h3>
                
                <div id="product-category-filters" class="category-filters no-print">
                    </div>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>H√¨nh ·∫¢nh</th>
                            <th>T√™n S·∫£n Ph·∫©m</th>
                            <th>Danh M·ª•c</th>
                            <th>Gi√°</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="product-list-body">
                        </tbody>
                </table>
            </section>

            <hr id="divider-staff-2" class="no-print" style="margin: 40px 0; border: 1px solid #ddd;">

            <section id="customer-section" class="customer-section no-print">
                <h2>üë• Qu·∫£n L√Ω Kh√°ch H√†ng</h2>
                <div id="customer-message-container" class="message"></div>
                
                <form id="add-customer-form" class="add-form">
                    <h3>Th√™m Kh√°ch H√†ng M·ªõi</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="custHoTen">H·ªç v√† T√™n:</label>
                            <input type="text" id="custHoTen" name="hoTen" required>
                        </div>
                        <div class="form-group">
                            <label for="custTenDangNhap">T√™n ƒêƒÉng Nh·∫≠p:</label>
                            <input type="text" id="custTenDangNhap" name="tenDangNhap" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="custMatKhau">M·∫≠t Kh·∫©u:</label>
                            <input type="password" id="custMatKhau" name="matKhau" required>
                        </div>
                        <div class="form-group">
                            <label for="custDienThoai">ƒêi·ªán Tho·∫°i:</label>
                            <input type="text" id="custDienThoai" name="dienThoai">
                        </div>
                    </div>
                     <div class="form-row">
                        <div class="form-group">
                            <label for="custEmail">Email:</label>
                            <input type="email" id="custEmail" name="email">
                        </div>
                        <div class="form-group">
                            <label for="custGioiTinh">Gi·ªõi T√≠nh:</label>
                            <select id="custGioiTinh" name="gioiTinh">
                                <option value="Kh√°c">Kh√°c</option>
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                            </select>
                        </div>
                    </div>
                     <div class="form-group">
                        <label for="custDiaChi">ƒê·ªãa Ch·ªâ:</label>
                        <textarea id="custDiaChi" name="diaChi" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn-submit">Th√™m Kh√°ch H√†ng</button>
                </form>

                <div class="search-bar">
                    <input type="search" id="customer-search-input" placeholder="T√¨m ki·∫øm theo T√™n, SƒêT, Email, T√™n ƒëƒÉng nh·∫≠p...">
                    <button id="customer-search-btn">T√¨m Ki·∫øm</button>
                </div>

                <h3>Danh S√°ch Kh√°ch H√†ng</h3>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>M√£ KH</th>
                            <th>H·ªç v√† T√™n</th>
                            <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                            <th>Email</th>
                            <th>ƒêi·ªán Tho·∫°i</th>
                            <th>ƒê·ªãa Ch·ªâ</th>
                            <th>Thao T√°c</th>
                        </tr>
                    </thead>
                    <tbody id="customer-list-body"></tbody>
                </table>
            </section>
            
            <hr id="divider-staff-3" class="no-print" style="margin: 40px 0; border: 1px solid #ddd;">
            <section id="review-management-section" class="review-management-section no-print">
                <h2>‚≠ê Qu·∫£n L√Ω ƒê√°nh Gi√°</h2>
                <div id="review-management-message-container" class="message"></div>
                <h3>Danh S√°ch ƒê√°nh Gi√° M·ªõi Nh·∫•t</h3>
                <div id="review-management-list">
                    </div>
            </section>

        </div>
    </div>


    <div id="edit-product-modal" class="modal no-print" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" data-modal="edit-product-modal">&times;</span>
            <h2>Ch·ªânh s·ª≠a S·∫£n ph·∫©m</h2>
            <div id="edit-product-message-container" class="message"></div>
            
            <form id="edit-product-form" class="add-form">
                <input type="hidden" id="editMaSanPham" name="maSanPham">
                
                <div class="form-group">
                    <label for="editTenSanPham">T√™n S·∫£n Ph·∫©m:</label>
                    <input type="text" id="editTenSanPham" name="tenSanPham" required>
                </div>
                <div class="form-group">
                    <label for="editGia">Gi√° (VNƒê):</label>
                    <input type="number" id="editGia" name="gia" required>
                </div>
                <div class="form-group">
                    <label for="editMaDanhMuc">Danh M·ª•c:</label>
                    <select id="editMaDanhMuc" name="maDanhMuc" required>
                        </select>
                </div>
                <div class="form-group">
                    <label for="editHinhAnhURL">Link H√¨nh ·∫¢nh (URL):</label>
                    <input type="text" id="editHinhAnhURL" name="hinhAnhURL" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label for="editMoTa">M√¥ T·∫£:</label>
                    <textarea id="editMoTa" name="moTa" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-submit" style="background-color: #007bff;">L∆∞u Thay ƒê·ªïi</button>
            </form>
        </div>
    </div>

    <div id="order-details-modal" class="modal no-print" style="display:none;">
        <div id="invoice-modal-content" class="modal-content printable-content" style="max-width: 800px;">
            <span class="close-modal no-print" data-modal="order-details-modal">&times;</span>
            
            <h2>Chi Ti·∫øt H√≥a ƒê∆°n</h2>
            <div id="invoice-details">
                </div>
            
            <button class="btn-print no-print" onclick="window.print()">In H√≥a ƒê∆°n</button>
        </div>
    </div>
    
    <div id="edit-customer-modal" class="modal no-print" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" data-modal="edit-customer-modal">&times;</span>
            <h2>Ch·ªânh s·ª≠a Kh√°ch h√†ng</h2>
            <div id="edit-customer-message-container" class="message"></div>
            
            <form id="edit-customer-form" class="add-form">
                <input type="hidden" id="editMaKhachHang" name="maKhachHang">
                
                 <div class="form-row">
                    <div class="form-group">
                        <label for="editCustHoTen">H·ªç v√† T√™n:</label>
                        <input type="text" id="editCustHoTen" name="hoTen" required>
                    </div>
                    <div class="form-group">
                         <label for="editCustEmail">Email:</label>
                        <input type="email" id="editCustEmail" name="email">
                    </div>
                </div>
                <div class="form-row">
                     <div class="form-group">
                        <label for="editCustDienThoai">ƒêi·ªán Tho·∫°i:</label>
                        <input type="text" id="editCustDienThoai" name="dienThoai">
                    </div>
                    <div class="form-group">
                        <label for="editCustGioiTinh">Gi·ªõi T√≠nh:</label>
                        <select id="editCustGioiTinh" name="gioiTinh">
                            <option value="Kh√°c">Kh√°c</option>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                        </select>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="editCustDiaChi">ƒê·ªãa Ch·ªâ:</label>
                    <textarea id="editCustDiaChi" name="diaChi" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label for="editCustMatKhau">M·∫≠t kh·∫©u m·ªõi (B·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi):</label>
                    <input type="password" id="editCustMatKhau" name="matKhau" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
                </div>
                <button type="submit" class="btn-submit" style="background-color: #007bff;">L∆∞u Thay ƒê·ªïi</button>
            </form>
        </div>
    </div>


    <script>
        // ----------------------------------------------------------------------
        // C√ÅC H√ÄM TR·ª¢ GI√öP (Helpers)
        // ----------------------------------------------------------------------
        
        // H√†m ƒë·ªãnh d·∫°ng s·ªë ti·ªÅn
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ƒë';
        }

        // H√†m hi·ªÉn th·ªã th√¥ng b√°o
        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (container) {
                container.textContent = message;
                container.className = `message ${type}`;
                container.style.display = 'block';
                setTimeout(() => {
                    container.style.display = 'none';
                }, 5000);
            }
        }
        
        // H√†m ƒë·ªãnh d·∫°ng ng√†y
        function formatNgay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        };


        // ----------------------------------------------------------------------
        // LOGIC ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T / B·∫¢O M·∫¨T
        // ----------------------------------------------------------------------

        // (ƒê√£ S·ª≠a) Hi·ªÉn th·ªã giao di·ªán ch√≠nh (Dashboard) THEO VAI TR√í
        function showDashboard(user) {
            // (S·ª¨A L·ªñI) Ch·ªâ c·∫ßn hi·ªÉn th·ªã dashboard, kh√¥ng c·∫ßn ·∫©n login-section
            document.getElementById('dashboard-section').style.display = 'block';
            
            // ƒêi·ªÅn th√¥ng tin user
            document.getElementById('user-name').textContent = user.hoTen;
            document.getElementById('user-role').textContent = user.role;
            
            // PH√ÇN QUY·ªÄN GIAO DI·ªÜN NGHI√äM NG·∫∂T (THEO USE CASE)
            if (user.role === 'Qu·∫£n l√Ω') {
                // Admin (Qu·∫£n l√Ω) CH·ªà th·∫•y Doanh thu, Nh√¢n vi√™n
                document.getElementById('revenue-section').style.display = 'block';
                document.getElementById('divider-admin').style.display = 'block';
                document.getElementById('employee-section').style.display = 'block';
                
                // ·∫®N PH·∫¶N C·ª¶A NH√ÇN VI√äN
                document.getElementById('order-section').style.display = 'none';
                document.getElementById('divider-staff-1').style.display = 'none';
                document.getElementById('product-section').style.display = 'none'; 
                document.getElementById('divider-staff-2').style.display = 'none';
                document.getElementById('customer-section').style.display = 'none';
                document.getElementById('divider-staff-3').style.display = 'none'; // (M·ªöI)
                document.getElementById('review-management-section').style.display = 'none'; // (M·ªöI)
                
                // T·∫£i d·ªØ li·ªáu cho Admin
                loadRevenue();
                loadEmployees();
                
            } else if (user.role === 'Nh√¢n vi√™n') {
                // Nh√¢n vi√™n CH·ªà th·∫•y ƒê∆°n h√†ng, S·∫£n ph·∫©m, Kh√°ch h√†ng, ƒê√°nh gi√°
                document.getElementById('revenue-section').style.display = 'none'; 
                document.getElementById('divider-admin').style.display = 'none'; 
                document.getElementById('employee-section').style.display = 'none';
                
                // HI·ªÜN PH·∫¶N C·ª¶A NH√ÇN VI√äN
                document.getElementById('order-section').style.display = 'block';
                document.getElementById('divider-staff-1').style.display = 'block';
                document.getElementById('product-section').style.display = 'block'; 
                document.getElementById('divider-staff-2').style.display = 'block';
                document.getElementById('customer-section').style.display = 'block';
                document.getElementById('divider-staff-3').style.display = 'block'; // (M·ªöI)
                document.getElementById('review-management-section').style.display = 'block'; // (M·ªöI)
                
                // T·∫£i d·ªØ li·ªáu cho Nh√¢n vi√™n
                loadCategories(); 
                loadProducts(); 
                loadOrders(); 
                loadCustomers(); 
                loadStaffReviews(); // (M·ªöI)
            }
        }

        // (S·ª¨A L·ªñI) Chuy·ªÉn h∆∞·ªõng v·ªÅ trang login.html
        function redirectToLogin() {
            document.getElementById('dashboard-section').style.display = 'none';
            window.location.href = 'login.html'; // Chuy·ªÉn h∆∞·ªõng
        }

        // X·ª≠ l√Ω Form ƒêƒÉng nh·∫≠p (ƒê√É B·ªä X√ìA)
        // async function handleLogin(event) { ... }

        // X·ª≠ l√Ω ƒêƒÉng xu·∫•t
        async function handleLogout() {
            try {
                await fetch('/api/logout');
                redirectToLogin(); // (S·ª¨A L·ªñI) Hi·ªÉn th·ªã l·∫°i form ƒëƒÉng nh·∫≠p
            } catch (error) {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
            }
        }

        // Ki·ªÉm tra session khi t·∫£i trang
        async function checkSession() {
            try {
                const response = await fetch('/api/check-session');
                const result = await response.json();
                
                if (result.success) {
                    if (result.user.role === 'Qu·∫£n l√Ω' || result.user.role === 'Nh√¢n vi√™n') {
                        showDashboard(result.user); // (ƒê√É PH√ÇN QUY·ªÄN)
                    } else {
                        // L√† Kh√°ch h√†ng nh∆∞ng ƒëang ·ªü trang Admin, ƒë√° v·ªÅ shop
                        window.location.href = 'shop.html';
                    }
                } else {
                    redirectToLogin(); // (S·ª¨A L·ªñI) Ch∆∞a ƒëƒÉng nh·∫≠p, chuy·ªÉn v·ªÅ login.html
                }
            } catch (error) {
                redirectToLogin(); // (S·ª¨A L·ªñI) L·ªói k·∫øt n·ªëi, chuy·ªÉn v·ªÅ login.html
            }
        }

        
        // ----------------------------------------------------------------------
        // D. LOGIC T·∫¢I DOANH THU (D√†nh cho Admin)
        // ----------------------------------------------------------------------
        async function loadRevenue() {
            const tableBody = document.getElementById('revenue-list-body');
            const totalRevenueEl = document.getElementById('total-revenue');
            tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">ƒêang t·∫£i...</td></tr>';
            totalRevenueEl.textContent = '0 ƒë';
            
            let tongCong = 0;

            try {
                const response = await fetch('/api/doanh-thu');
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    tableBody.innerHTML = ''; 
                    
                    result.data.forEach(item => {
                        const tongTheoNgay = parseFloat(item.TongDoanhThu);
                        tongCong += tongTheoNgay;

                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${formatNgay(item.Ngay)}</td>
                            <td class="revenue-amount">${formatCurrency(tongTheoNgay)}</td> 
                        `;
                    });

                    totalRevenueEl.textContent = formatCurrency(tongCong);

                } else if (result.success && result.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Ch∆∞a c√≥ doanh thu n√†o.</td></tr>';
                } else {
                    showMessage('revenue-message-container', result.message, 'error');
                    tableBody.innerHTML = `<tr><td colspan="2" style="text-align:center;">${result.message}</td></tr>`;
                }

            } catch (error) {
                console.error('L·ªói khi t·∫£i doanh thu:', error);
                showMessage('revenue-message-container', 'L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn xem Doanh thu.', 'error');
                tableBody.innerHTML = '<tr><td colspan="2" style="text-align:center;">Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.</td></tr>';
            }
        }
        
        // ----------------------------------------------------------------------
        // E. LOGIC IN B√ÅO C√ÅO DOANH THU (D√†nh cho Admin)
        // ----------------------------------------------------------------------
        function handlePrintRevenue() {
            // Logic in c·ªßa Doanh thu (ph·∫ßn .printable-content)
            window.print();
        }


        // ----------------------------------------------------------------------
        // F. LOGIC QU·∫¢N L√ù NH√ÇN VI√äN (D√†nh cho Admin)
        // ----------------------------------------------------------------------
        async function handleAddEmployee(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/them-nhan-vien', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('employee-message-container', result.message, 'success');
                    form.reset(); 
                    loadEmployees(); 
                } else {
                    showMessage('employee-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('employee-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }

        async function loadEmployees() {
            const tableBody = document.getElementById('employee-list-body');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ƒêang t·∫£i...</td></tr>';

            try {
                const response = await fetch('/api/nhan-vien');
                const result = await response.json();
                if (result.success && result.data.length > 0) {
                    tableBody.innerHTML = ''; 
                    result.data.forEach(nv => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${nv.MaNguoiDung}</td>
                            <td>${nv.HoTen}</td>
                            <td>${nv.TenDangNhap}</td>
                            <td>
                                <button class="btn-delete" data-type="employee" data-id="${nv.MaNguoiDung}">X√≥a</button>
                            </td>
                        `;
                    });
                } else if (result.success && result.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ch∆∞a c√≥ nh√¢n vi√™n n√†o.</td></tr>';
                } else {
                    showMessage('employee-message-container', result.message, 'error');
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">L·ªói t·∫£i d·ªØ li·ªáu.</td></tr>';
                }
            } catch (error) {
                showMessage('employee-message-container', 'L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn xem danh s√°ch Nh√¢n vi√™n.', 'error');
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.</td></tr>';
            }
        }

        // ----------------------------------------------------------------------
        // G. LOGIC QU·∫¢N L√ù S·∫¢N PH·∫®M (D√†nh cho Nh√¢n vi√™n)
        // ----------------------------------------------------------------------
        
        // (S·ª¨A L·ªñI) H√†m tr·ª£ gi√∫p l·∫•y URL ·∫£nh (thay th·∫ø null/"" V√Ä x·ª≠ l√Ω l·ªói 404)
        function getProductImageUrl(url) {
            const placeholder = 'https://placehold.co/100x100/EEE/333?text=No+Image';
            if (url && url.trim() !== '') {
                // Tr·∫£ v·ªÅ URL v√† th√™m 'onerror' ƒë·ªÉ b·∫Øt l·ªói 404 (link h·ªèng)
                return `src="${url}" onerror="this.src='${placeholder}';"`;
            }
            // Tr·∫£ v·ªÅ placeholder n·∫øu URL l√† null ho·∫∑c ""
            return `src="${placeholder}"`;
        }

        // T·∫£i danh m·ª•c v√†o dropdown (C·∫≠p nh·∫≠t: T·∫£i cho c·∫£ 2 form V√Ä TABS L·ªåC)
        async function loadCategories() {
            const selectAdd = document.getElementById('maDanhMuc');
            const selectEdit = document.getElementById('editMaDanhMuc'); 
            const filterContainer = document.getElementById('product-category-filters'); // (M·ªöI)
            
            try {
                const response = await fetch('/api/danh-muc');
                const result = await response.json();
                if (result.success) {
                    // X√≥a "ƒêang t·∫£i" ·ªü c·∫£ 2 form
                    selectAdd.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>'; 
                    selectEdit.innerHTML = '<option value="">-- Ch·ªçn danh m·ª•c --</option>'; 
                    
                    // (M·ªöI) Build filter tabs
                    filterContainer.innerHTML = ''; // Clear old tabs
                    const allTab = document.createElement('button');
                    allTab.className = 'filter-tab active'; // "T·∫•t c·∫£" is active by default
                    allTab.textContent = 'T·∫•t c·∫£';
                    allTab.dataset.category = ''; // Empty string for "all"
                    filterContainer.appendChild(allTab);
                    
                    result.data.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat.MaDanhMuc;
                        option.textContent = cat.TenDanhMuc;
                        
                        selectAdd.appendChild(option);
                        selectEdit.appendChild(option.cloneNode(true));
                        
                        // (M·ªöI) Add tab for this category
                        const tab = document.createElement('button');
                        tab.className = 'filter-tab';
                        tab.textContent = cat.TenDanhMuc;
                        tab.dataset.category = cat.TenDanhMuc;
                        filterContainer.appendChild(tab);
                    });
                }
            } catch (error) {
                selectAdd.innerHTML = '<option value="">-- L·ªói t·∫£i danh m·ª•c --</option>';
                selectEdit.innerHTML = '<option value="">-- L·ªói t·∫£i danh m·ª•c --</option>';
                filterContainer.innerHTML = '<p class="message error">L·ªói t·∫£i danh m·ª•c.</p>';
            }
        }

        // T·∫£i danh s√°ch s·∫£n ph·∫©m (C·∫¨P NH·∫¨T: Ch·∫•p nh·∫≠n l·ªçc theo category)
        async function loadProducts(categoryName = '') { // (M·ªöI) Th√™m tham s·ªë
            const tableBody = document.getElementById('product-list-body');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">ƒêang t·∫£i s·∫£n ph·∫©m...</td></tr>';
            
            try {
                // (M·ªöI) Th√™m tham s·ªë l·ªçc v√†o URL
                const response = await fetch(`/api/san-pham?category=${encodeURIComponent(categoryName)}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    tableBody.innerHTML = '';
                    result.data.forEach(sp => {
                        const row = tableBody.insertRow();
                        // (S·ª¨A L·ªñI) G·ªçi h√†m getProductImageUrl
                        const imageUrlHtml = getProductImageUrl(sp.HinhAnhURL); 
                        
                        row.innerHTML = `
                            <td>
                                <img ${imageUrlHtml} 
                                 alt="${sp.TenSanPham}" 
                                 style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                            </td>
                            <td>${sp.TenSanPham}</td>
                            <td>${sp.TenDanhMuc || 'N/A'}</td>
                            <td>${formatCurrency(parseFloat(sp.Gia))}</td>
                            <td>
                                <button class="btn-edit" data-type="product" data-id="${sp.MaSanPham}">S·ª≠a</button>
                                <button class="btn-delete" data-type="product" data-id="${sp.MaSanPham}">X√≥a</button>
                            </td>
                        `;
                    });
                } else if (result.success && result.data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">${categoryName ? 'Kh√¥ng c√≥ s·∫£n ph·∫©m' : 'Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.'}</td></tr>`;
                } else {
                    showMessage('product-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('product-message-container', 'L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn xem S·∫£n ph·∫©m.', 'error');
            }
        }

        // Th√™m s·∫£n ph·∫©m (Gi·ªØ nguy√™n)
        async function handleAddProduct(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/san-pham', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('product-message-container', result.message, 'success');
                    form.reset();
                    loadProducts(); // T·∫£i l·∫°i danh s√°ch s·∫£n ph·∫©m
                } else {
                    showMessage('product-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('product-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        // M·ªü Modal Ch·ªânh s·ª≠a
        async function openEditModal(modalId, id, type) {
            const modal = document.getElementById(modalId);
            try {
                // 1. G·ªçi API l·∫•y chi ti·∫øt
                const response = await fetch(`/api/${type}/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    
                    // 2. ƒê·ªï d·ªØ li·ªáu v√†o form ch·ªânh s·ª≠a (t√πy lo·∫°i)
                    if(type === 'san-pham') { // (S·ª¨A L·ªñI)
                        document.getElementById('editMaSanPham').value = data.MaSanPham;
                        document.getElementById('editTenSanPham').value = data.TenSanPham;
                        document.getElementById('editGia').value = parseFloat(data.Gia);
                        document.getElementById('editMaDanhMuc').value = data.MaDanhMuc;
                        document.getElementById('editHinhAnhURL').value = data.HinhAnhURL;
                        document.getElementById('editMoTa').value = data.MoTa;
                    } else if (type === 'khach-hang') { // (S·ª¨A L·ªñI)
                        document.getElementById('editMaKhachHang').value = data.MaNguoiDung;
                        document.getElementById('editCustHoTen').value = data.HoTen;
                        document.getElementById('editCustEmail').value = data.Email;
                        document.getElementById('editCustDienThoai').value = data.DienThoai;
                        document.getElementById('editCustGioiTinh').value = data.GioiTinh;
                        document.getElementById('editCustDiaChi').value = data.DiaChi;
                        document.getElementById('editCustMatKhau').value = ''; // Lu√¥n tr·ªëng
                    }
                    
                    // 3. Hi·ªÉn th·ªã modal
                    modal.style.display = 'block';
                } else {
                    alert(`L·ªói: ${result.message}`);
                }
            } catch (error) {
                alert(`L·ªói k·∫øt n·ªëi khi l·∫•y chi ti·∫øt ${type}.`);
            }
        }
        
        // (S·ª≠a l·ªói) ƒê√≥ng Modal
        function closeModals(event) {
             if (event.target.classList.contains('close-modal')) {
                const modalId = event.target.dataset.modal;
                document.getElementById(modalId).style.display = 'none';
            }
        }
        
        // X·ª≠ l√Ω L∆∞u Thay ƒê·ªïi (C·∫≠p nh·∫≠t S·∫£n ph·∫©m)
        async function handleUpdateProduct(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const id = data.maSanPham; // L·∫•y ID t·ª´ tr∆∞·ªùng ·∫©n

            try {
                const response = await fetch(`/api/san-pham/${id}`, {
                    method: 'PUT', // D√πng PUT ƒë·ªÉ C·∫≠p nh·∫≠t
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('edit-product-message-container', result.message, 'success');
                    setTimeout(() => {
                        document.getElementById('edit-product-modal').style.display = 'none';
                        loadProducts();
                    }, 1000);
                } else {
                    showMessage('edit-product-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('edit-product-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        // ----------------------------------------------------------------------
        // (M·ªöI) H. LOGIC QU·∫¢N L√ù ƒê∆†N H√ÄNG (D√†nh cho Nh√¢n vi√™n)
        // ----------------------------------------------------------------------
        
        // T·∫£i danh s√°ch ƒë∆°n h√†ng (S·ª¨A L·ªñI: Th√™m n√∫t "Duy·ªát")
        async function loadOrders() {
            const tableBody = document.getElementById('order-list-body');
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">ƒêang t·∫£i ƒë∆°n h√†ng...</td></tr>';
            
            try {
                const response = await fetch('/api/don-hang');
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    tableBody.innerHTML = '';
                    result.data.forEach(dh => {
                        const row = tableBody.insertRow();
                        
                        // (S·ª¨A L·ªñI) Logic N√∫t b·∫•m/Dropdown theo tr·∫°ng th√°i
                        let statusHtml = '';
                        const trangThai = dh.TrangThai;
                        
                        if (trangThai === 'Ch·ªù X√°c Nh·∫≠n') {
                            statusHtml = `<button class="btn-action btn-approve" data-id="${dh.MaDonHang}" data-next-status="ƒêang x·ª≠ l√Ω">Duy·ªát ƒê∆°n</button>`;
                        } else if (trangThai === 'ƒêang x·ª≠ l√Ω') {
                            statusHtml = `<button class="btn-action btn-ship" data-id="${dh.MaDonHang}" data-next-status="ƒêang giao">G·ª≠i H√†ng</button>`;
                        } else if (trangThai === 'ƒêang giao') {
                             statusHtml = `<button class="btn-action btn-complete" data-id="${dh.MaDonHang}" data-next-status="Ho√†n th√†nh">Ho√†n Th√†nh</button>`;
                        } else if (trangThai === 'Ho√†n th√†nh') {
                            statusHtml = `<span class="status-completed">ƒê√£ Ho√†n Th√†nh</span>`;
                        } else if (trangThai === 'ƒê√£ h·ªßy') {
                            statusHtml = `<span class="status-cancelled">ƒê√£ H·ªßy</span>`;
                        }
                        
                        row.innerHTML = `
                            <td>${dh.MaDonHang}</td>
                            <td>${formatNgay(dh.NgayDatHang)}</td>
                            <td>${dh.TenKhachHang || 'N/A'}</td>
                            <td class="revenue-amount">${formatCurrency(parseFloat(dh.TongTien))}</td>
                            <td>
                                ${statusHtml}
                            </td>
                            <td>
                                <button class="btn-invoice" data-type="order" data-id="${dh.MaDonHang}">In Hƒê</button>
                            </td>
                        `;
                    });
                } else if (result.success && result.data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</td></tr>';
                } else {
                    showMessage('order-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('order-message-container', 'L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn xem ƒê∆°n h√†ng.', 'error');
            }
        }
        
        // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng (S·ª¨A L·ªñI: D√πng chung cho c√°c n√∫t)
        async function updateOrderStatus(id, newStatus) {
            try {
                const response = await fetch(`/api/don-hang/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ trangThai: newStatus })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('order-message-container', `C·∫≠p nh·∫≠t ƒë∆°n h√†ng #${id} th√†nh "${newStatus}"!`, 'success');
                    loadOrders(); // T·∫£i l·∫°i b·∫£ng ƒë∆°n h√†ng
                } else {
                    showMessage('order-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('order-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        // M·ªü Modal In H√≥a ƒê∆°n
        async function openInvoiceModal(id) {
            const modal = document.getElementById('order-details-modal');
            const content = document.getElementById('invoice-details');
            content.innerHTML = '<p>ƒêang t·∫£i chi ti·∫øt h√≥a ƒë∆°n...</p>';
            modal.style.display = 'block';

            try {
                const response = await fetch(`/api/don-hang/${id}/details`);
                const result = await response.json();
                
                if (result.success) {
                    const { order, items } = result;
                    let itemsHtml = '';
                    let subTotal = 0;
                    
                    items.forEach(item => {
                        const total = parseFloat(item.GiaLucDat) * item.SoLuong;
                        subTotal += total;
                        itemsHtml += `
                            <tr>
                                <td>${item.TenSanPham}</td>
                                <td style="text-align:center;">${item.SoLuong}</td>
                                <td class="revenue-amount">${formatCurrency(parseFloat(item.GiaLucDat))}</td>
                                <td class="revenue-amount">${formatCurrency(total)}</td>
                            </tr>
                        `;
                    });
                    
                    content.innerHTML = `
                        <div class="invoice-header">
                            <h3>H√ìA ƒê∆†N B√ÅN H√ÄNG</h3>
                            <p>M√£ ƒêH: #${order.MaDonHang}</p>
                            <p>Ng√†y: ${formatNgay(order.NgayDatHang)}</g>
                        </div>
                        <hr>
                        <div class="invoice-customer">
                            <strong>Kh√°ch h√†ng:</strong> ${order.HoTen}<br>
                            <strong>ƒêi·ªán tho·∫°i:</strong> ${order.DienThoai || 'N/A'}<br>
                            <strong>ƒê·ªãa ch·ªâ:</strong> ${order.DiaChi || 'N/A'}
                        </div>
                        <hr>
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>S·∫£n ph·∫©m</th>
                                    <th>SL</th>
                                    <th>ƒê∆°n gi√°</th>
                                    <th>Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" style="text-align:right; font-weight: bold;">T·ªîNG C·ªòNG</td>
                                    <td class="revenue-amount">${formatCurrency(subTotal)}</td>
                                </tr>
                                 <tr>
                                    <td colspan="3" style="text-align:right; font-weight: bold; color: red;">T·ªîNG H√ìA ƒê∆†N</td>
                                    <td class="revenue-amount" style="color: red;">${formatCurrency(parseFloat(order.TongTien))}</td>
                                </tr>
                            </tfoot>
                        </table>
                        <p style="text-align:center; margin-top: 30px;">C·∫£m ∆°n qu√Ω kh√°ch!</p>
                    `;
                    
                } else {
                    content.innerHTML = `<p class="message error">${result.message}</p>`;
                }
            } catch (error) {
                 content.innerHTML = `<p class="message error">L·ªói k·∫øt n·ªëi Server.</p>`;
            }
        }
        
        // ----------------------------------------------------------------------
        // (M·ªöI) I. LOGIC QU·∫¢N L√ù KH√ÅCH H√ÄNG (D√†nh cho Nh√¢n vi√™n)
        // ----------------------------------------------------------------------
        
        // (C·∫≠p nh·∫≠t) T·∫£i danh s√°ch kh√°ch h√†ng (c√≥ t√¨m ki·∫øm)
        async function loadCustomers(searchTerm = '') {
            const tableBody = document.getElementById('customer-list-body');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">ƒêang t·∫£i kh√°ch h√†ng...</td></tr>';
            
            try {
                // Th√™m ?search=... v√†o API
                const response = await fetch(`/api/khach-hang?search=${encodeURIComponent(searchTerm)}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    tableBody.innerHTML = '';
                    result.data.forEach(kh => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${kh.MaNguoiDung}</td>
                            <td>${kh.HoTen}</td>
                            <td>${kh.TenDangNhap}</td>
                            <td>${kh.Email || 'N/A'}</td>
                            <td>${kh.DienThoai || 'N/A'}</td>
                            <td>${kh.DiaChi || 'N/A'}</td>
                            <td>
                                <button class="btn-edit" data-type="customer" data-id="${kh.MaNguoiDung}">S·ª≠a</button>
                                <button class="btn-delete" data-type="customer" data-id="${kh.MaNguoiDung}">X√≥a</button>
                            </td>
                        `;
                    });
                } else if (result.success && result.data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">${searchTerm ? 'Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.' : 'Ch∆∞a c√≥ kh√°ch h√†ng n√†o.'}</td></tr>`;
                } else {
                    showMessage('customer-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('customer-message-container', 'L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn xem Kh√°ch h√†ng.', 'error');
            }
        }
        
        // (M·ªöI) X·ª≠ l√Ω n√∫t t√¨m ki·∫øm
        function handleSearchCustomer() {
            const searchTerm = document.getElementById('customer-search-input').value;
            loadCustomers(searchTerm);
        }
        
        // (C·∫≠p nh·∫≠t) Th√™m kh√°ch h√†ng (v·ªõi email, gi·ªõit√≠nh)
        async function handleAddCustomer(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/khach-hang', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('customer-message-container', result.message, 'success');
                    form.reset();
                    loadCustomers(); // T·∫£i l·∫°i danh s√°ch kh√°ch h√†ng
                } else {
                    showMessage('customer-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('customer-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        // (M·ªöI) X·ª≠ l√Ω C·∫≠p nh·∫≠t (L∆∞u) Kh√°ch h√†ng
        async function handleUpdateCustomer(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            const id = data.maKhachHang; 

            try {
                const response = await fetch(`/api/khach-hang/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('edit-customer-message-container', result.message, 'success');
                    setTimeout(() => {
                        document.getElementById('edit-customer-modal').style.display = 'none';
                        loadCustomers(); // T·∫£i l·∫°i b·∫£ng kh√°ch h√†ng
                    }, 1000);
                } else {
                    showMessage('edit-customer-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('edit-customer-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        // ----------------------------------------------------------------------
        // (M·ªöI) J. LOGIC QU·∫¢N L√ù ƒê√ÅNH GI√Å (D√†nh cho Nh√¢n vi√™n)
        // ----------------------------------------------------------------------
        
        // T·∫£i t·∫•t c·∫£ ƒë√°nh gi√°
        async function loadStaffReviews() {
            const container = document.getElementById('review-management-list');
            container.innerHTML = '<p>ƒêang t·∫£i ƒë√°nh gi√°...</p>';
            
            try {
                const response = await fetch('/api/staff/reviews');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    container.innerHTML = '';
                    result.data.forEach(r => {
                        const likedClass = r.ShopDaTim ? 'liked' : '';
                        const replyText = r.ShopTraLoi || '';
                        
                        container.innerHTML += `
                            <div class="staff-review-item">
                                <div class="staff-review-header">
                                    <span>S·∫£n ph·∫©m: <strong>${r.TenSanPham}</strong></span>
                                    <span>Kh√°ch h√†ng: <strong>${r.TenKhachHang}</strong></span>
                                    <span class="star-rating-display sm">${'‚òÖ'.repeat(r.SoSao)}${'‚òÜ'.repeat(5 - r.SoSao)}</span>
                                </div>
                                <p class="review-comment">"${r.BinhLuan || '<i>Kh√¥ng c√≥ b√¨nh lu·∫≠n</i>'}"</p>
                                <div class="staff-reply-area">
                                    <textarea id="reply-text-${r.MaDanhGia}" rows="2" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa Shop...">${replyText}</textarea>
                                    <button class="btn-reply" data-id="${r.MaDanhGia}">G·ª≠i Tr·∫£ L·ªùi</button>
                                    <button class="btn-like-review ${likedClass}" data-id="${r.MaDanhGia}" data-liked="${r.ShopDaTim ? '1' : '0'}">
                                        ‚ù§Ô∏è ${r.ShopDaTim ? 'ƒê√£ Tim' : 'Th·∫£ Tim'}
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else if (result.success) {
                    container.innerHTML = '<p>Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>';
                } else {
                    showMessage('review-management-message-container', result.message, 'error');
                }
            } catch (error) {
                 showMessage('review-management-message-container', 'L·ªói: B·∫°n kh√¥ng c√≥ quy·ªÅn xem ƒê√°nh gi√°.', 'error');
            }
        }
        
        // X·ª≠ l√Ω G·ª≠i Tr·∫£ L·ªùi
        async function handleReplyReview(id) {
            const replyText = document.getElementById(`reply-text-${id}`).value;
            if (!replyText) {
                showMessage('review-management-message-container', 'Vui l√≤ng nh·∫≠p n·ªôi dung tr·∫£ l·ªùi.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/staff/reviews/${id}/reply`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shopTraLoi: replyText })
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('review-management-message-container', 'G·ª≠i tr·∫£ l·ªùi th√†nh c√¥ng!', 'success');
                } else {
                    showMessage('review-management-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('review-management-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        // X·ª≠ l√Ω Th·∫£ Tim
        async function handleLikeReview(id, currentLiked) {
            const isNowLiked = !currentLiked; // ƒê·∫£o ng∆∞·ª£c tr·∫°ng th√°i
            
             try {
                const response = await fetch(`/api/staff/reviews/${id}/like`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ daTim: isNowLiked })
                });
                const result = await response.json();
                if (result.success) {
                    // C·∫≠p nh·∫≠t giao di·ªán n√∫t
                    const btn = document.querySelector(`.btn-like-review[data-id="${id}"]`);
                    btn.dataset.liked = isNowLiked ? '1' : '0';
                    btn.textContent = `‚ù§Ô∏è ${isNowLiked ? 'ƒê√£ Tim' : 'Th·∫£ Tim'}`;
                    btn.classList.toggle('liked', isNowLiked);
                } else {
                    showMessage('review-management-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('review-management-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }

        
        // (C·∫¨P NH·∫¨T) X·ª≠ l√Ω Click (S·ª≠a/X√≥a/In Hƒê/Duy·ªát ƒê∆°n/Tr·∫£ l·ªùi/Tim)
        async function handleTableClick(event) {
            const target = event.target;
            
            if (!target) return;
            
            const id = target.dataset.id;
            const type = target.dataset.type;

            // X·ª≠ l√Ω n√∫t X√ìA
            if (target.classList.contains('btn-delete')) {
                let url = '';
                let confirmMessage = '';
                let loadFunction = null;

                if (type === 'employee') {
                    url = `/api/xoa-nhan-vien/${id}`;
                    confirmMessage = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n c√≥ M√£: ${id} kh√¥ng?`;
                    loadFunction = loadEmployees;
                } else if (type === 'product') {
                    url = `/api/san-pham/${id}`;
                    confirmMessage = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·∫£n ph·∫©m c√≥ M√£: ${id} kh√¥ng?`;
                    loadFunction = loadProducts;
                } else if (type === 'customer') { // (M·ªöI)
                    url = `/api/khach-hang/${id}`;
                    confirmMessage = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng c√≥ M√£: ${id} kh√¥ng? (ƒê∆°n h√†ng c·ªßa h·ªç v·∫´n c√≤n)`;
                    loadFunction = loadCustomers;
                }
                 else {
                    return;
                }

                if (confirm(confirmMessage)) {
                    try {
                        const response = await fetch(url, { method: 'DELETE' });
                        const result = await response.json();
                        if (result.success) {
                            alert(result.message);
                            if (loadFunction) loadFunction(); // T·∫£i l·∫°i b·∫£ng
                        } else {
                            alert(`L·ªói: ${result.message}`);
                        }
                    } catch (error) {
                        alert('L·ªói k·∫øt n·ªëi Server khi x√≥a.');
                    }
                }
            }
            
            // X·ª≠ l√Ω n√∫t S·ª¨A
            if (target.classList.contains('btn-edit')) {
                if (type === 'product') {
                    openEditModal('edit-product-modal', id, 'san-pham'); 
                } else if (type === 'customer') {
                    openEditModal('edit-customer-modal', id, 'khach-hang'); 
                }
            }
            
            // X·ª≠ l√Ω n√∫t IN H√ìA ƒê∆†N
             if (target.classList.contains('btn-invoice') && type === 'order') {
                openInvoiceModal(id);
            }
            
            // X·ª≠ l√Ω c√°c N√öT H√ÄNH ƒê·ªòNG C·ª¶A ƒê∆†N H√ÄNG
            if (target.classList.contains('btn-action')) {
                const id = target.dataset.id;
                const nextStatus = target.dataset.nextStatus;
                
                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn ƒë∆°n h√†ng #${id} sang "${nextStatus}"?`)) {
                    updateOrderStatus(id, nextStatus);
                }
            }
            
            // (M·ªöI) X·ª≠ l√Ω N√∫t Tr·∫£ L·ªùi ƒê√°nh Gi√°
             if (target.classList.contains('btn-reply')) {
                 const id = target.dataset.id;
                 handleReplyReview(id);
             }
             
             // (M·ªöI) X·ª≠ l√Ω N√∫t Th·∫£ Tim ƒê√°nh Gi√°
             if (target.classList.contains('btn-like-review')) {
                 const id = target.dataset.id;
                 const currentLiked = target.dataset.liked === '1';
                 handleLikeReview(id, currentLiked);
             }
        }

        
        // ----------------------------------------------------------------------
        // KH·ªûI T·∫†O CHUNG
        // ----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            checkSession(); 

            // 2. G√°n s·ª± ki·ªán cho c√°c form v√† n√∫t
            // document.getElementById('login-form').addEventListener('submit', handleLogin); // ƒê√É X√ìA
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('add-product-form').addEventListener('submit', handleAddProduct); 
            document.getElementById('add-customer-form').addEventListener('submit', handleAddCustomer); // (M·ªöI)
            
            document.getElementById('edit-product-form').addEventListener('submit', handleUpdateProduct); 
            document.getElementById('edit-customer-form').addEventListener('submit', handleUpdateCustomer); // (M·ªöI)
            
            document.getElementById('print-revenue-btn').addEventListener('click', handlePrintRevenue);
            
            // (M·ªöI) G√°n s·ª± ki·ªán cho N√∫t t√¨m ki·∫øm
            document.getElementById('customer-search-btn').addEventListener('click', handleSearchCustomer);
            document.getElementById('customer-search-input').addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearchCustomer();
            });

            // G√°n s·ª± ki·ªán Click cho B·∫£ng (S·ª≠a/X√≥a/In Hƒê/Duy·ªát ƒê∆°n/Tr·∫£ l·ªùi/Tim)
            document.body.addEventListener('click', handleTableClick); 
            
            // (X√ìA) G√°n s·ª± ki·ªán thay ƒë·ªïi tr·∫°ng th√°i ƒê∆°n h√†ng (ƒë√£ g·ªôp v√†o handleTableClick)
            // document.body.addEventListener('change', handleUpdateOrderStatus); 
            
            // G√°n s·ª± ki·ªán ƒë√≥ng Modal
            document.body.addEventListener('click', closeModals); // (C·∫¨P NH·∫¨T)
            
            // (M·ªöI) G√°n s·ª± ki·ªán cho Filter Tabs (S·∫£n ph·∫©m)
            document.getElementById('product-category-filters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    // L·∫•y t√™n category
                    const categoryName = e.target.dataset.category;
                    
                    // X√≥a "active" class kh·ªèi t·∫•t c·∫£ c√°c tab
                    document.querySelectorAll('#product-category-filters .filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    
                    // Th√™m "active" class cho tab v·ª´a click
                    e.target.classList.add('active');
                    
                    // T·∫£i l·∫°i s·∫£n ph·∫©m
                    loadProducts(categoryName);
                }
            });
        });
    </script>
</body>
</html>