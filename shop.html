<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·ª≠a H√†ng Qu·∫ßn √Åo</title>
    <link rel="stylesheet" href="shop.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header class="shop-header">
        <div style="text-align:center; color:#d32f2f; font-size:1.5em; font-weight:bold; margin: 10px 0; letter-spacing:1px;">K√≠nh Ch√†o Qu√Ω Kh√°ch</div>
        <div class="shop-container header-content">
            <a href="/shop.html" class="logo">Qu·∫ßn √Åo Mina</a>
            
            <nav class="main-nav">
                <a href="#" class="nav-link" data-view="shop-view">üëï C·ª≠a H√†ng</a>
                <a href="#" class="nav-link" data-view="account-view">üë§ T√†i Kho·∫£n</a>
                <a href="tryon.html" class="nav-link">‚ú® Th·ª≠ ƒê·ªì (AI)</a>
            </nav>

            <div class="header-actions">
                <div id="guest-links">
                    <a href="/login.html" class="nav-link">ƒêƒÉng Nh·∫≠p</a>
                    <a href="#" class="nav-link btn-register" data-view="register-view">ƒêƒÉng K√Ω</a>
                </div>
                <div id="user-links" style="display: none;">
                    <span id="welcome-user">Ch√†o, </span>
                    <button id="cart-button" class="nav-link cart-btn">üõí Gi·ªè H√†ng (<span id="cart-count">0</span>)</button>
                    <button id="logout-button" class="nav-link">ƒêƒÉng Xu·∫•t</button>
                </div>
            </div>
        </div>
    </header>

    <main class="shop-container">
        
        <div id="shop-view">
            <h2>S·∫£n Ph·∫©m C·ªßa Ch√∫ng T√¥i</h2>
            
            <div id="product-category-filters" class="category-filters">
                </div>

            <div id="product-list" class="product-grid">
                </div>
        </div>

        <div id="account-view" style="display: none;">
            <h2>T√†i Kho·∫£n C·ªßa T√¥i</h2>
            
            <div class="account-tabs">
                <button class="account-tab active" data-tab="profile">H·ªì S∆° C·ªßa T√¥i</button>
                <button class="account-tab" data-tab="orders">L·ªãch S·ª≠ ƒê∆°n H√†ng</button>
                <button class="account-tab" data-tab="tryon-history">üì∏ ·∫¢nh ƒê√£ Th·ª≠</button>
            </div>

            <div class="account-content">
                <div id="profile-tab" class="tab-pane active">
                     <h3>H·ªì S∆° C·ªßa T√¥i</h3>
                    <p>Qu·∫£n l√Ω th√¥ng tin h·ªì s∆° ƒë·ªÉ b·∫£o m·∫≠t t√†i kho·∫£n</p>
                    <div id="profile-message-container" class="message"></div>
                    
                    <form id="update-profile-form" class="account-form">
                         <div class="form-group">
                            <label>T√™n ƒêƒÉng Nh·∫≠p:</label>
                            <input type="text" id="accTenDangNhap" disabled>
                        </div>
                        <div class="form-group">
                            <label>H·ªç v√† T√™n:</label>
                            <input type="text" id="accHoTen" name="hoTen">
                        </div>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="accEmail" name="email">
                        </div>
                        <div class="form-group">
                            <label>S·ªë ƒêi·ªán Tho·∫°i:</label>
                            <input type="text" id="accDienThoai" name="dienThoai">
                        </div>
                        <div class="form-group">
                            <label>ƒê·ªãa Ch·ªâ:</label>
                            <textarea id="accDiaChi" name="diaChi" rows="3"></textarea>
                        </div>
                         <div class="form-group">
                            <label>Gi·ªõi T√≠nh:</label>
                            <select id="accGioiTinh" name="gioiTinh">
                                <option value="Kh√°c">Kh√°c</option>
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>M·∫≠t kh·∫©u m·ªõi (B·ªè tr·ªëng n·∫øu kh√¥ng ƒë·ªïi):</label>
                            <input type="password" name="matKhau" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi...">
                        </div>
                        <button type="submit" class="btn-primary">L∆∞u Thay ƒê·ªïi</button>
                    </form>
                    
                    <div class="danger-zone">
                        <h3>H·ªßy T√†i Kho·∫£n</h3>
                        <p>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c. T·∫•t c·∫£ d·ªØ li·ªáu c·ªßa b·∫°n s·∫Ω b·ªã x√≥a (n·∫øu b·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o).</p>
                        <button id="delete-account-btn" class="btn-danger">H·ªßy T√†i Kho·∫£n C·ªßa T√¥i</button>
                    </div>
                </div>
                
                <div id="orders-tab" class="tab-pane">
                    <h3>L·ªãch S·ª≠ ƒê∆°n H√†ng</h3>
                    <div id="order-history-list">
                        </div>
                </div>

                <div id="tryon-history-tab" class="tab-pane">
                    <h3>·∫¢nh ƒê√£ Th·ª≠ C·ªßa B·∫°n</h3>
                    <p>ƒê√¢y l√† nh·ªØng h√¨nh ·∫£nh b·∫°n ƒë√£ l∆∞u t·ª´ t√≠nh nƒÉng "Th·ª≠ ƒê·ªì".</p>
                    <div id="tryon-history-message" class="message"></div>
                    <div id="tryon-history-list" class="tryon-history-grid">
                        </div>
                </div>
            </div>
        </div>

        <div id="register-view" style="display: none;">
            <h2>ƒêƒÉng K√Ω T√†i Kho·∫£n M·ªõi</h2>
            <div id="register-message-container" class="message"></div>
            <form id="register-form" class="account-form" style="max-width: 600px; margin: auto;">
                 <div class="form-row">
                    <div class="form-group">
                        <label for="regHoTen">H·ªç v√† T√™n:</label>
                        <input type="text" id="regHoTen" name="hoTen" required>
                    </div>
                    <div class="form-group">
                        <label for="regTenDangNhap">T√™n ƒêƒÉng Nh·∫≠p:</label>
                        <input type="text" id="regTenDangNhap" name="tenDangNhap" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="regMatKhau">M·∫≠t Kh·∫©u:</label>
                        <input type="password" id="regMatKhau" name="matKhau" required>
                    </div>
                    <div class="form-group">
                        <label for="regDienThoai">ƒêi·ªán Tho·∫°i:</label>
                        <input type="text" id="regDienThoai" name="dienThoai">
                    </div>
                </div>
                 <div class="form-row">
                    <div class="form-group">
                        <label for="regEmail">Email:</label>
                        <input type="email" id="regEmail" name="email">
                    </div>
                    <div class="form-group">
                        <label for="regGioiTinh">Gi·ªõi T√≠nh:</label>
                        <select id="regGioiTinh" name="gioiTinh">
                            <option value="Kh√°c">Kh√°c</option>
                            <option value="Nam">Nam</option>
                            <option value="N·ªØ">N·ªØ</option>
                        </select>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="regDiaChi">ƒê·ªãa Ch·ªâ:</label>
                    <textarea id="regDiaChi" name="diaChi" rows="2"></textarea>
                </div>
                <button type="submit" class="btn-primary">ƒêƒÉng K√Ω</button>
            </form>
        </div>

    </main>
    
    <div id="cart-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close-modal" data-modal="cart-modal">&times;</span>
            <h2>Gi·ªè H√†ng C·ªßa B·∫°n</h2>
            <div id="cart-message-container" class="message"></div>
            <div id="cart-items-container"></div>
            <div class="cart-summary">
                <strong>T·ªïng C·ªông: <span id="cart-total">0 ƒë</span></strong>
            </div>
            <div class="cart-actions">
                <button id="checkout-cod-btn" class="btn-primary">Thanh to√°n khi nh·∫≠n h√†ng (COD)</button>
                <button id="checkout-qr-btn" class="btn-secondary">Chuy·ªÉn kho·∫£n (Qu√©t QR)</button>
            </div>
        </div>
    </div>
    
    <div id="thank-you-modal" class="modal">
         <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-modal" data-modal="thank-you-modal">&times;</span>
            <h2>ƒê·∫∑t H√†ng Th√†nh C√¥ng!</h2>
            <p>C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng. ƒê∆°n h√†ng c·ªßa b·∫°n (<strong id="new-order-id"></strong>) ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω.</p>
            <p>B·∫°n c√≥ th·ªÉ theo d√µi tr·∫°ng th√°i ƒë∆°n h√†ng trong m·ª•c <strong>T√†i Kho·∫£n</strong>.</p>
            <button class="btn-primary" data-view="account-view">Xem L·ªãch S·ª≠ ƒê∆°n H√†ng</button>
        </div>
    </div>
    
    <div id="qr-code-modal" class="modal">
         <div class="modal-content" style="max-width: 500px; text-align: center;">
            <span class="close-modal" data-modal="qr-code-modal">&times;</span>
            <h2>Thanh to√°n Chuy·ªÉn kho·∫£n</h2>
            <p>Vui l√≤ng qu√©t m√£ QR d∆∞·ªõi ƒë√¢y ƒë·ªÉ thanh to√°n.</p>
            <div id="qr-code-container">
                <img id="qr-code-image" src="https://placehold.co/300x300/EEE/333?text=Dang+Tao+Ma" alt="QR Code Thanh toan" style="width: 300px; height: 300px; margin: auto; display: block;">
            </div>
            <div class="qr-details">
                <p>Ng√¢n h√†ng: <strong>Ng√¢n h√†ng ABC (Demo)</strong></p>
                <p>S·ªë t√†i kho·∫£n: <strong>123456789</strong></p>
                <p>Ch·ªß t√†i kho·∫£n: <strong>Qu·∫ßn √Åo Mina</strong></p>
                <p>S·ªë ti·ªÅn: <strong id="qr-amount" style="color: red; font-size: 1.2rem;">0 ƒë</strong></p>
                <p>N·ªôi dung: <strong id="qr-content" style="color: #007bff;"></strong></p>
            </div>
            <hr>
            <p>Sau khi thanh to√°n, vui l√≤ng nh·∫•n n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ ho√†n t·∫•t ƒë∆°n h√†ng.</p>
            <button id="qr-paid-btn" class="btn-primary" style="background-color: #28a745;">T√¥i ƒë√£ thanh to√°n (T·∫°o ƒë∆°n h√†ng)</button>
        </div>
    </div>
    
    <div id="product-detail-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close-modal" data-modal="product-detail-modal">&times;</span>
            <div id="product-detail-content" class="product-detail-grid"></div>
            <hr>
            <div class="detail-tabs">
                <button class="detail-tab active" data-tab="detail-tab-desc">M√¥ T·∫£</button>
                <button class="detail-tab" data-tab="detail-tab-reviews">ƒê√°nh Gi√°</button>
            </div>
            <div class="detail-tab-content">
                <div id="detail-tab-desc" class="detail-tab-pane active"></div>
                <div id="detail-tab-reviews" class="detail-tab-pane">
                    <div id="review-form-container" style="display: none;">
                        <h3>Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h3>
                        <div id="review-message-container" class="message"></div>
                        <form id="review-form" class="add-form">
                            <input type="hidden" id="reviewMaSanPham" name="maSanPham">
                            <div class="form-group">
                                <label>Ch·∫•t l∆∞·ª£ng s·∫£n ph·∫©m:</label>
                                <div class="star-rating">
                                    <input type="radio" id="star5" name="soSao" value="5" required/><label for="star5" title="5 sao">‚òÖ</label>
                                    <input type="radio" id="star4" name="soSao" value="4" required/><label for="star4" title="4 sao">‚òÖ</label>
                                    <input type="radio" id="star3" name="soSao" value="3" required/><label for="star3" title="3 sao">‚òÖ</label>
                                    <input type="radio" id="star2" name="soSao" value="2" required/><label for="star2" title="2 sao">‚òÖ</label>
                                    <input type="radio" id="star1" name="soSao" value="1" required/><label for="star1" title="1 sao">‚òÖ</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="reviewBinhLuan">B√¨nh lu·∫≠n:</label>
                                <textarea id="reviewBinhLuan" name="binhLuan" rows="4" placeholder="S·∫£n ph·∫©m n√†y r·∫•t..."></textarea>
                            </div>
                            <button type="submit" class="btn-primary">G·ª≠i ƒê√°nh Gi√°</button>
                        </form>
                    </div>
                    <div id="review-form-message"></div>
                    <h3>T·∫•t c·∫£ ƒë√°nh gi√°</h3>
                    <div id="review-list-container"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="review-order-modal" class="modal">
         <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" data-modal="review-order-modal">&times;</span>
            <h2>Ch·ªçn S·∫£n Ph·∫©m C·∫ßn ƒê√°nh Gi√°</h2>
            <p>ƒê∆°n h√†ng n√†y c√≥ c√°c s·∫£n ph·∫©m sau. Vui l√≤ng ch·ªçn 1 s·∫£n ph·∫©m ƒë·ªÉ vi·∫øt ƒë√°nh gi√°:</p>
            <div id="review-order-products-list"></div>
        </div>
    </div>


    <script>
        // ----------------------------------------------------------------------
        // C√ÅC H√ÄM TR·ª¢ GI√öP (Helpers)
        // ----------------------------------------------------------------------
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN').format(amount) + ' ƒë';
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (container) {
                container.textContent = message;
                container.className = `message ${type}`;
                container.style.display = 'block';
                setTimeout(() => {
                    container.style.display = 'none';
                }, 5000);
            }
        }
        
        function formatNgay(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
        };
        
        function getProductImageUrl(url) {
            const placeholder = 'https://placehold.co/300x300/EEE/333?text=No+Image';
            if (url && url.trim() !== '') {
                return `src="${url}" onerror="this.src='${placeholder}';"`;
            }
            return `src="${placeholder}"`;
        }

        // ----------------------------------------------------------------------
        // QU·∫¢N L√ù TR·∫†NG TH√ÅI (State)
        // ----------------------------------------------------------------------
        let G_USER_DATA = null; // L∆∞u th√¥ng tin ng∆∞·ªùi d√πng
        let G_CART = []; // L∆∞u gi·ªè h√†ng
        let G_CURRENT_TOTAL = 0; // (M·ªöI) L∆∞u t·ªïng ti·ªÅn
        
        function loadCartFromStorage() {
            const storedCart = localStorage.getItem('myShopCart');
            G_CART = storedCart ? JSON.parse(storedCart) : [];
            updateCartUI();
        }
        
        function saveCartToStorage() {
            localStorage.setItem('myShopCart', JSON.stringify(G_CART));
            updateCartUI();
        }
        
        function updateCartUI() {
            const cartContainer = document.getElementById('cart-items-container');
            const cartTotalEl = document.getElementById('cart-total');
            const cartCountEl = document.getElementById('cart-count');
            
            // (S·ª¨A L·ªñI) Ki·ªÉm tra c√°c element t·ªìn t·∫°i tr∆∞·ªõc khi d√πng
            if (!cartContainer || !cartTotalEl || !cartCountEl) return;
            
            cartContainer.innerHTML = '';
            let total = 0;
            let count = 0;

            if (G_CART.length === 0) {
                cartContainer.innerHTML = '<p style="text-align:center;">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>';
            } else {
                G_CART.forEach((item, index) => {
                    const itemTotal = item.Gia * (item.SoLuong || 1); // Th√™m || 1
                    total += itemTotal;
                    count += (item.SoLuong || 1);
                    
                    cartContainer.innerHTML += `
                        <div class="cart-item">
                            <img ${getProductImageUrl(item.HinhAnhURL)} alt="${item.TenSanPham}" style="width: 70px; height: 70px;">
                            <div class="cart-item-info">
                                <strong>${item.TenSanPham}</strong>
                                <span>${formatCurrency(item.Gia)}</span>
                            </div>
                            <div class="cart-item-actions">
                                <input type="number" class="cart-item-qty" value="${item.SoLuong}" min="1" data-index="${index}">
                                <button class="btn-delete" data-index="${index}">X√≥a</button>
                            </div>
                            <strong class="cart-item-total">${formatCurrency(itemTotal)}</strong>
                        </div>
                    `;
                });
            }
            
            cartTotalEl.textContent = formatCurrency(total);
            cartCountEl.textContent = count;
            G_CURRENT_TOTAL = total; 
        }


        // ----------------------------------------------------------------------
        // ƒêI·ªÄU H∆Ø·ªöNG V√Ä HI·ªÇN TH·ªä (Navigation)
        // ----------------------------------------------------------------------
        
        function showView(viewId) {
            document.getElementById('shop-view').style.display = 'none';
            document.getElementById('account-view').style.display = 'none';
            document.getElementById('register-view').style.display = 'none';
            document.getElementById(viewId).style.display = 'block';
            document.querySelectorAll('.modal').forEach(modal => modal.style.display = 'none');
        }
        
        // (C·∫¨P NH·∫¨T) S·ª≠a l·ªói logic hi·ªÉn th·ªã Tab
        function showTab(tabId) {
            document.querySelectorAll('.account-content .tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.account-tab').forEach(tab => tab.classList.remove('active'));
            
            const pane = document.getElementById(tabId);
            if(pane) pane.classList.add('active');
            
            const tabButton = document.querySelector(`.account-tab[data-tab="${tabId.replace('-tab', '')}"]`);
            if(tabButton) tabButton.classList.add('active');
        }
        
        // (M·ªöI) H√†m chuy·ªÉn tab trong Modal Chi ti·∫øt SP
        function showDetailTab(tabId) {
             document.querySelectorAll('.detail-tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.detail-tab[data-tab="${tabId}"]`).classList.add('active');
        }

        // ----------------------------------------------------------------------
        // LOGIC ƒêƒÇNG NH·∫¨P / ƒêƒÇNG XU·∫§T / B·∫¢O M·∫¨T (C·∫¨P NH·∫¨T)
        // ----------------------------------------------------------------------
        
        async function checkSession_Customer() {
            try {
                const response = await fetch('/api/check-session');
                const result = await response.json();
                
                if (result.success && result.user.role === 'Kh√°ch h√†ng') {
                    G_USER_DATA = result.user;
                    document.getElementById('guest-links').style.display = 'none';
                    document.getElementById('user-links').style.display = 'block';
                    document.getElementById('welcome-user').textContent = `Ch√†o, ${result.user.hoTen}`;
                    loadAccountDetails(); 
                    loadOrderHistory(); 
                    loadTryOnHistory(); // (M·ªöI) T·∫£i l·ªãch s·ª≠ ·∫£nh ƒë√£ th·ª≠
                } else if (result.success) {
                    window.location.href = 'index.html';
                }
                 else {
                    G_USER_DATA = null;
                    document.getElementById('guest-links').style.display = 'flex';
                    document.getElementById('user-links').style.display = 'none';
                }
            } catch (error) {
                G_USER_DATA = null;
                document.getElementById('guest-links').style.display = 'flex';
                document.getElementById('user-links').style.display = 'none';
            }
        }
        
        async function handleLogout_Customer() {
            try {
                await fetch('/api/logout');
                G_USER_DATA = null;
                checkSession_Customer(); 
                showView('shop-view'); 
            } catch (error) {
                console.error('L·ªói ƒëƒÉng xu·∫•t:', error);
            }
        }
        
        // ----------------------------------------------------------------------
        // LOGIC C·ª¨A H√ÄNG (SHOP) V√Ä GI·ªé H√ÄNG (CART)
        // ----------------------------------------------------------------------
        
        // T·∫£i danh m·ª•c (Public)
        async function loadCategories_Customer() {
            const filterContainer = document.getElementById('product-category-filters');
            try {
                const response = await fetch('/api/public/categories'); // D√πng API Public
                const result = await response.json();
                if (result.success) {
                    filterContainer.innerHTML = '';
                    const allTab = document.createElement('button');
                    allTab.className = 'filter-tab active';
                    allTab.textContent = 'T·∫•t c·∫£';
                    allTab.dataset.category = ''; 
                    filterContainer.appendChild(allTab);
                    
                    result.data.forEach(cat => {
                        const tab = document.createElement('button');
                        tab.className = 'filter-tab';
                        tab.textContent = cat.TenDanhMuc;
                        tab.dataset.category = cat.TenDanhMuc;
                        filterContainer.appendChild(tab);
                    });
                }
            } catch (error) {
                filterContainer.innerHTML = '<p class="message error">L·ªói t·∫£i danh m·ª•c.</p>';
            }
        }

        // T·∫£i s·∫£n ph·∫©m (Public)
        async function loadProducts_Customer(categoryName = '') {
            const productList = document.getElementById('product-list');
            productList.innerHTML = '<p>ƒêang t·∫£i s·∫£n ph·∫©m...</p>';
            
            try {
                const response = await fetch(`/api/public/products?category=${encodeURIComponent(categoryName)}`);
                const result = await response.json();

                if (result.success && result.data.length > 0) {
                    productList.innerHTML = '';
                    result.data.forEach(sp => {
                        productList.innerHTML += `
                            <div class="product-card" data-id="${sp.MaSanPham}">
                                <img ${getProductImageUrl(sp.HinhAnhURL)} alt="${sp.TenSanPham}" class="product-clickable">
                                <div class="product-info">
                                    <h3 class="product-clickable">${sp.TenSanPham}</h3>
                                    <p>${sp.TenDanhMuc || 'N/A'}</p>
                                    <strong>${formatCurrency(parseFloat(sp.Gia))}</strong>
                                    
                                    <div class="product-actions">
                                        <button class="btn-add-to-cart" 
                                            data-id="${sp.MaSanPham}"
                                            data-name="${sp.TenSanPham}"
                                            data-price="${sp.Gia}"
                                            data-img="${sp.HinhAnhURL || ''}"
                                        >
                                            Th√™m v√†o gi·ªè
                                        </button>
                                        <button class="btn-buy-now" 
                                            data-id="${sp.MaSanPham}"
                                            data-name="${sp.TenSanPham}"
                                            data-price="${sp.Gia}"
                                            data-img="${sp.HinhAnhURL || ''}"
                                        >
                                            Mua Ngay
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else if (result.success && result.data.length === 0) {
                    productList.innerHTML = `<p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</p>`;
                } else {
                    productList.innerHTML = `<p class="message error">${result.message}</p>`;
                }
            } catch (error) {
                productList.innerHTML = `<p class="message error">L·ªói k·∫øt n·ªëi Server.</p>`;
            }
        }
        
        function handleAddToCart(event, showAlert = true) {
            const btn = event.target;
            const id = btn.dataset.id;
            const existingItem = G_CART.find(item => item.MaSanPham === id);
            
            if (existingItem) {
                existingItem.SoLuong += 1;
            } else {
                G_CART.push({
                    MaSanPham: id,
                    TenSanPham: btn.dataset.name,
                    Gia: parseFloat(btn.dataset.price),
                    HinhAnhURL: btn.dataset.img,
                    SoLuong: 1
                });
            }
            saveCartToStorage();
            if (showAlert) {
                alert('ƒê√£ th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng!');
            }
        }
        
        function handleBuyNow(event) {
            G_CART = [];
            handleAddToCart(event, false); 
            document.getElementById('cart-modal').style.display = 'block';
        }
        
        function handleUpdateCartQty(event) {
            const index = event.target.dataset.index;
            const newQty = parseInt(event.target.value, 10);
            
            if (newQty > 0) {
                G_CART[index].SoLuong = newQty;
            } else {
                G_CART.splice(index, 1);
            }
            saveCartToStorage();
        }
        
        function handleDeleteCartItem(event) {
            const index = event.target.dataset.index;
            G_CART.splice(index, 1);
            saveCartToStorage();
        }
        
        async function handleCheckout() {
            if (G_CART.length === 0) {
                showMessage('cart-message-container', 'Gi·ªè h√†ng tr·ªëng. Kh√¥ng th·ªÉ thanh to√°n.', 'error');
                return;
            }
            if (!G_USER_DATA) {
                 showMessage('cart-message-container', 'B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n.', 'error');
                 setTimeout(() => {
                     document.getElementById('cart-modal').style.display = 'none';
                     window.location.href = 'login.html'; 
                 }, 2000);
                 return;
            }
            
            const items = G_CART.map(item => ({
                MaSanPham: item.MaSanPham,
                SoLuong: item.SoLuong,
                GiaLucDat: item.Gia 
            }));

            try {
                const response = await fetch('/api/customer/checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: items, tongTien: G_CURRENT_TOTAL })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    G_CART = []; 
                    saveCartToStorage();
                    document.getElementById('cart-modal').style.display = 'none';
                    document.getElementById('qr-code-modal').style.display = 'none';
                    document.getElementById('new-order-id').textContent = `#${result.orderId}`;
                    document.getElementById('thank-you-modal').style.display = 'block';
                } else {
                    showMessage('cart-message-container', result.message, 'error');
                    showMessage('qr-message-container', result.message, 'error');
                }
            } catch (error) {
                 showMessage('cart-message-container', 'L·ªói k·∫øt n·ªëi Server khi thanh to√°n.', 'error');
                 showMessage('qr-message-container', 'L·ªói k·∫øt n·ªëi Server khi thanh to√°n.', 'error');
            }
        }
        
        function handleShowQR() {
             if (G_CART.length === 0 || G_CURRENT_TOTAL === 0) {
                showMessage('cart-message-container', 'Gi·ªè h√†ng tr·ªëng. Kh√¥ng th·ªÉ thanh to√°n.', 'error');
                return;
            }
            if (!G_USER_DATA) {
                 showMessage('cart-message-container', 'B·∫°n ph·∫£i ƒëƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n.', 'error');
                 return;
            }
            const amount = G_CURRENT_TOTAL;
            const content = `DH${G_USER_DATA.id}${Date.now()}`; 
            const itemNames = G_CART.map(item => item.TenSanPham).join(', ');
            const qrString = `TT: ${amount} | ND: ${content} | (${itemNames})`;
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrString)}`;
            
            document.getElementById('qr-code-image').src = qrApiUrl;
            document.getElementById('qr-amount').textContent = formatCurrency(amount);
            document.getElementById('qr-content').textContent = content;
            
            document.getElementById('cart-modal').style.display = 'none';
            document.getElementById('qr-code-modal').style.display = 'block';
        }

        
        // ----------------------------------------------------------------------
        // LOGIC T√ÄI KHO·∫¢N (ACCOUNT) V√Ä ƒêƒÇNG K√ù (REGISTER) (C·∫¨P NH·∫¨T)
        // ----------------------------------------------------------------------
        
        async function loadOrderHistory() {
            const container = document.getElementById('order-history-list');
            container.innerHTML = '<p>ƒêang t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng...</p>';
            
            try {
                // (S·ª¨A L·ªñI) API N√ÄY B·ªä THI·∫æU TRONG server.js
                // B·∫°n PH·∫¢I th√™m API n√†y v√†o server.js (xem l·∫°i ph·∫£n h·ªìi tr∆∞·ªõc c·ªßa t√¥i)
                const response = await fetch('/api/customer/orders');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    container.innerHTML = '';
                    result.data.forEach(order => {
                        let statusClass = '';
                        let reviewButtonHtml = '';
                        
                        switch(order.TrangThai) {
                            case 'Ho√†n th√†nh': 
                                statusClass = 'status-completed'; 
                                reviewButtonHtml = `<button class="btn-review-order" data-id="${order.MaDonHang}">Vi·∫øt ƒê√°nh Gi√°</button>`;
                                break;
                            case 'ƒê√£ h·ªßy': statusClass = 'status-cancelled'; break;
                            case 'ƒêang giao': statusClass = 'status-shipping'; break;
                            case 'Ch·ªù X√°c Nh·∫≠n': statusClass = 'status-waiting'; break; 
                            default: statusClass = 'status-processing'; 
                        }
                        
                        container.innerHTML += `
                            <div class="order-history-item">
                                <div class="order-item-header">
                                    <span>M√£ ƒêH: #${order.MaDonHang}</span>
                                    <span class="order-status ${statusClass}">${order.TrangThai}</span>
                                </div>
                                <div class="order-item-body">
                                    <p>Ng√†y ƒë·∫∑t: ${formatNgay(order.NgayDatHang)}</p>
                                    <p>T·ªïng ti·ªÅn: <strong>${formatCurrency(parseFloat(order.TongTien))}</strong></p>
                                    ${reviewButtonHtml}
                                </div>
                            </div>
                        `;
                    });
                } else if (result.success) {
                     container.innerHTML = '<p>B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
                } else {
                     container.innerHTML = `<p class="message error">${result.message}</p>`;
                }
            } catch (error) {
                 container.innerHTML = `<p class="message error">L·ªói t·∫£i l·ªãch s·ª≠ ƒë∆°n h√†ng. (Ki·ªÉm tra API /api/customer/orders)</p>`;
            }
        }
        
        async function loadAccountDetails() {
            if (!G_USER_DATA) return;
            
            try {
                const response = await fetch('/api/customer/profile');
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('accTenDangNhap').value = data.TenDangNhap;
                    document.getElementById('accHoTen').value = data.HoTen;
                    document.getElementById('accEmail').value = data.Email;
                    document.getElementById('accDienThoai').value = data.DienThoai;
                    document.getElementById('accDiaChi').value = data.DiaChi;
                    document.getElementById('accGioiTinh').value = data.GioiTinh || 'Kh√°c';
                } else {
                    showMessage('profile-message-container', result.message, 'error');
                }
                 
            } catch (e) {
                console.error("L·ªói load chi ti·∫øt t√†i kho·∫£n", e);
                showMessage('profile-message-container', 'L·ªói k·∫øt n·ªëi khi t·∫£i h·ªì s∆°.', 'error');
            }
        }
        
        async function handleUpdateCustomer_Profile(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch(`/api/customer/profile`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                if (result.success) {
                    showMessage('profile-message-container', result.message, 'success');
                    document.getElementById('welcome-user').textContent = `Ch√†o, ${data.hoTen}`;
                } else {
                    showMessage('profile-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('profile-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        async function handleRegister(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/public/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    showMessage('register-message-container', result.message, 'success');
                    setTimeout(() => {
                         window.location.href = 'login.html'; 
                    }, 2000);
                } else {
                    showMessage('register-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('register-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        async function handleDeleteAccount() {
            if (!G_USER_DATA) return;
            
            const ten = G_USER_DATA.username;
            if (prompt(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën H·ª¶Y t√†i kho·∫£n '${ten}'? H√†nh ƒë·ªông n√†y KH√îNG TH·ªÇ ho√†n t√°c. Nh·∫≠p 'DELETE' ƒë·ªÉ x√°c nh·∫≠n.`) === 'DELETE') {
                try {
                    const response = await fetch('/api/customer/delete-account', {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        alert(result.message);
                        handleLogout_Customer(); 
                    } else {
                        alert(`L·ªói: ${result.message}`);
                    }
                } catch (error) {
                    alert('L·ªói k·∫øt n·ªëi Server.');
                }
            } else {
                alert('H√†nh ƒë·ªông ƒë√£ ƒë∆∞·ª£c h·ªßy.');
            }
        }
        
        // (M·ªöI) T·∫£i l·ªãch s·ª≠ ·∫£nh Try-On (API 22 t·ª´ server.js)
        async function loadTryOnHistory() {
            if (!G_USER_DATA) return;
            const container = document.getElementById('tryon-history-list');
            if (!container) return; 
            container.innerHTML = '<p>ƒêang t·∫£i ·∫£nh ƒë√£ l∆∞u...</p>';
            
            try {
                const response = await fetch('/api/customer/tryon');
                const result = await response.json(); 
                
                if (Array.isArray(result) && result.length > 0) {
                    container.innerHTML = '';
                    result.forEach(image => {
                        container.innerHTML += `
                            <div class="tryon-history-item">
                                <img src="${image.url}" alt="·∫¢nh ƒë√£ th·ª≠ ${image.filename}">
                                <button class="btn-delete-tryon" data-filename="${image.filename}">&times;</button>
                            </div>
                        `;
                    });
                } else {
                    container.innerHTML = '<p>B·∫°n ch∆∞a l∆∞u ·∫£nh th·ª≠ ƒë·ªì n√†o.</p>';
                }
            } catch (error) {
                showMessage('tryon-history-message', 'L·ªói t·∫£i l·ªãch s·ª≠ ·∫£nh ƒë√£ th·ª≠.', 'error');
            }
        }
        
        // (M·ªöI) X√≥a ·∫£nh Try-On (API 34 t·ª´ server.js)
        async function handleDeleteTryOnImage(filename) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?`)) return;
            
            try {
                const response = await fetch(`/api/customer/tryon/${filename}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('tryon-history-message', 'ƒê√£ x√≥a ·∫£nh.', 'success');
                    loadTryOnHistory(); 
                } else {
                    showMessage('tryon-history-message', result.message, 'error');
                }
            } catch (error) {
                showMessage('tryon-history-message', 'L·ªói k·∫øt n·ªëi khi x√≥a ·∫£nh.', 'error');
            }
        }

        // ----------------------------------------------------------------------
        // LOGIC XEM CHI TI·∫æT V√Ä ƒê√ÅNH GI√Å (Modal)
        // ----------------------------------------------------------------------
        
        async function openProductDetailModal(id, options = {}) {
             const modal = document.getElementById('product-detail-modal');
            const content = document.getElementById('product-detail-content');
            const descTab = document.getElementById('detail-tab-desc');
            const reviewList = document.getElementById('review-list-container');
            const reviewFormContainer = document.getElementById('review-form-container');
            const reviewFormMessage = document.getElementById('review-form-message');
            
            content.innerHTML = '<p>ƒêang t·∫£i chi ti·∫øt s·∫£n ph·∫©m...</p>';
            descTab.innerHTML = '';
            reviewList.innerHTML = '';
            reviewFormContainer.style.display = 'none';
            reviewFormMessage.innerHTML = '';
            
            modal.style.display = 'block';
            
             showDetailTab('detail-tab-desc');

            try {
                const response = await fetch(`/api/public/products/${id}`);
                const result = await response.json();
                
                if (result.success) {
                    const { product, reviews, userStatus } = result.data;
                    
                    content.innerHTML = `
                        <div class="product-detail-image">
                            <img ${getProductImageUrl(product.HinhAnhURL)} alt="${product.TenSanPham}">
                        </div>
                        <div class="product-detail-info">
                            <h2>${product.TenSanPham}</h2>
                            <p>Danh m·ª•c: ${product.TenDanhMuc || 'N/A'}</p>
                            <strong class="product-detail-price">${formatCurrency(parseFloat(product.Gia))}</strong>
                            <div class="product-actions">
                                <button class="btn-add-to-cart" data-id="${product.MaSanPham}" data-name="${product.TenSanPham}" data-price="${product.Gia}" data-img="${product.HinhAnhURL || ''}">Th√™m v√†o gi·ªè</button>
                                <button class="btn-buy-now" data-id="${product.MaSanPham}" data-name="${product.TenSanPham}" data-price="${product.Gia}" data-img="${product.HinhAnhURL || ''}">Mua Ngay</button>
                            </div>
                        </div>
                    `;
                    
                    descTab.innerHTML = `<p>${product.MoTa ? product.MoTa.replace(/\n/g, '<br>') : 'S·∫£n ph·∫©m n√†y ch∆∞a c√≥ m√¥ t·∫£.'}</p>`;
                    
                    if (reviews.length > 0) {
                        reviewList.innerHTML = ''; // (S·ª¨A L·ªñI) X√≥a list c≈©
                        reviews.forEach(r => {
                            let shopReplyHtml = '';
                            if (r.ShopTraLoi) {
                                shopReplyHtml = `
                                    <div class="review-reply">
                                        <strong>Shop Qu·∫ßn √Åo ƒë√£ tr·∫£ l·ªùi:</strong>
                                        <p>${r.ShopTraLoi}</p>
                                    </div>
                                `;
                            }
                            
                            reviewList.innerHTML += `
                                <div class="review-item">
                                    <div class="review-header">
                                        <strong>${r.TenKhachHang}</strong>
                                        <span class="star-rating-display">${'‚òÖ'.repeat(r.SoSao)}${'‚òÜ'.repeat(5 - r.SoSao)}</span>
                                    </div>
                                    <p class="review-comment">${r.BinhLuan || '<i>Kh√¥ng c√≥ b√¨nh lu·∫≠n</i>'}</p>
                                    <span class="review-date">${formatNgay(r.NgayDanhGia)}</span>
                                    ${shopReplyHtml}
                                </div>
                            `;
                        });
                    } else {
                        reviewList.innerHTML = '<p>S·∫£n ph·∫©m n√†y ch∆∞a c√≥ ƒë√°nh gi√° n√†o.</p>';
                    }
                    
                    document.getElementById('reviewMaSanPham').value = product.MaSanPham; 
                    
                    if (userStatus.isLoggedIn) {
                        if (userStatus.hasReviewed) {
                            reviewFormMessage.innerHTML = '<p class="message success">B·∫°n ƒë√£ ƒë√°nh gi√° s·∫£n ph·∫©m n√†y.</p>';
                        } else if (userStatus.hasPurchased) {
                            reviewFormContainer.style.display = 'block'; 
                        } else {
                            reviewFormMessage.innerHTML = '<p>B·∫°n ph·∫£i mua s·∫£n ph·∫©m n√†y v√† ƒë∆°n h√†ng ƒë√£ ho√†n th√†nh m·ªõi c√≥ th·ªÉ ƒë√°nh gi√°.</p>';
                        }
                    } else {
                        reviewFormMessage.innerHTML = '<p>Vui l√≤ng <a href="/login.html">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ vi·∫øt ƒë√°nh gi√°.</p>';
                    }
                    
                    if(options.switchToReviewTab) {
                        showDetailTab('detail-tab-reviews');
                    }
                    
                } else {
                    content.innerHTML = `<p class="message error">${result.message}</p>`;
                }
            } catch (error) {
                content.innerHTML = `<p class="message error">L·ªói k·∫øt n·ªëi Server.</p>`;
            }
        }
        
        async function handleReviewSubmit(event) {
             event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/api/customer/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                
                if (result.success) {
                    showMessage('review-message-container', result.message, 'success');
                    form.reset();
                    document.getElementById('review-form-container').style.display = 'none'; 
                    openProductDetailModal(data.maSanPham, { switchToReviewTab: true }); 
                } else {
                    showMessage('review-message-container', result.message, 'error');
                }
            } catch (error) {
                showMessage('review-message-container', 'L·ªói k·∫øt n·ªëi Server.', 'error');
            }
        }
        
        async function openOrderReviewModal(orderId) {
            const modal = document.getElementById('review-order-modal');
            const listContainer = document.getElementById('review-order-products-list');
            listContainer.innerHTML = '<p>ƒêang t·∫£i s·∫£n ph·∫©m c·ªßa ƒë∆°n h√†ng...</p>';
            modal.style.display = 'block';
            
            try {
                const response = await fetch(`/api/customer/orders/${orderId}/details`);
                const result = await response.json();
                
                if (result.success && result.items.length > 0) {
                    listContainer.innerHTML = '';
                    result.items.forEach(item => {
                        listContainer.innerHTML += `
                            <div class="review-order-item">
                                <span>${item.TenSanPham} (SL: ${item.SoLuong})</span>
                                <button class="btn-review-product" data-id="${item.MaSanPham}">ƒê√°nh Gi√°</button>
                            </div>
                        `;
                    });
                } else if (result.success) {
                    listContainer.innerHTML = '<p>ƒê∆°n h√†ng n√†y kh√¥ng c√≥ s·∫£n ph·∫©m.</p>';
                } else {
                    listContainer.innerHTML = `<p class="message error">${result.message}</p>`;
                }
            } catch (error) {
                 listContainer.innerHTML = `<p class="message error">L·ªói k·∫øt n·ªëi Server.</p>`;
            }
        }

        
        // ----------------------------------------------------------------------
        // KH·ªûI T·∫†O CHUNG (Event Listeners)
        // ----------------------------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            
            // (S·ª¨A L·ªñI) T·∫£i d·ªØ li·ªáu c∆° b·∫£n (lu√¥n lu√¥n ch·∫°y)
            checkSession_Customer(); 
            loadCategories_Customer();
            loadProducts_Customer(); 
            loadCartFromStorage();

            // (M·ªöI) Ki·ªÉm tra xem c√≥ c·∫ßn chuy·ªÉn tab T√†i kho·∫£n kh√¥ng
            const viewOnLoad = localStorage.getItem('viewOnLoad');
            if (viewOnLoad === 'account-view') {
                showView('account-view');
                // T·ª± ƒë·ªông nh·∫£y ƒë·∫øn tab "·∫¢nh ƒê√£ Th·ª≠"
                setTimeout(() => { 
                     const tryOnTab = document.querySelector('.account-tab[data-tab="tryon-history"]');
                     if(tryOnTab) tryOnTab.click();
                }, 100);
                localStorage.removeItem('viewOnLoad'); 
            } else {
                showView('shop-view'); // M·∫∑c ƒë·ªãnh
            }


            // 2. G√°n s·ª± ki·ªán cho Header
            document.getElementById('logout-button').addEventListener('click', handleLogout_Customer);
            document.getElementById('cart-button').addEventListener('click', () => {
                document.getElementById('cart-modal').style.display = 'block';
            });

            // 3. G√°n s·ª± ki·ªán ƒêi·ªÅu h∆∞·ªõng (Navigation)
            document.querySelectorAll('.nav-link[data-view]').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.target.dataset.view;
                    showView(viewId);
                });
            });
            
            // 4. G√°n s·ª± ki·ªán Tabs (T√†i kho·∫£n)
            document.querySelectorAll('.account-tab').forEach(tab => {
                 tab.addEventListener('click', (e) => {
                     e.preventDefault();
                     const tabId = e.target.dataset.tab + '-tab';
                     showTab(tabId);
                 });
            });
            
             // 5. G√°n s·ª± ki·ªán Form
             document.getElementById('register-form').addEventListener('submit', handleRegister);
             document.getElementById('update-profile-form').addEventListener('submit', handleUpdateCustomer_Profile);
             document.getElementById('delete-account-btn').addEventListener('click', handleDeleteAccount); 
             // (S·ª¨A L·ªñI) Ki·ªÉm tra null tr∆∞·ªõc khi g√°n s·ª± ki·ªán
             const reviewForm = document.getElementById('review-form');
             if (reviewForm) {
                reviewForm.addEventListener('submit', handleReviewSubmit); 
             }

            // 6. G√°n s·ª± ki·ªán L·ªçc S·∫£n ph·∫©m
            document.getElementById('product-category-filters').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const categoryName = e.target.dataset.category;
                    document.querySelectorAll('#product-category-filters .filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    loadProducts_Customer(categoryName);
                }
            });
            
            // 7. G√°n s·ª± ki·ªán C·ª≠a h√†ng (Th√™m v√†o gi·ªè / Mua ngay / Xem Chi ti·∫øt)
            document.getElementById('product-list').addEventListener('click', (e) => {
                 if (e.target.classList.contains('btn-add-to-cart')) {
                    handleAddToCart(e, true); 
                }
                 else if (e.target.classList.contains('btn-buy-now')) {
                    handleBuyNow(e);
                }
                 else if (e.target.classList.contains('product-clickable')) {
                     const card = e.target.closest('.product-card');
                     openProductDetailModal(card.dataset.id);
                 }
            });

            // 8. G√°n s·ª± ki·ªán Gi·ªè h√†ng (Modal)
            document.getElementById('cart-items-container').addEventListener('change', (e) => {
                 if (e.target.classList.contains('cart-item-qty')) {
                    handleUpdateCartQty(e);
                }
            });
             document.getElementById('cart-items-container').addEventListener('click', (e) => {
                 if (e.target.classList.contains('btn-delete')) {
                    handleDeleteCartItem(e);
                }
            });
            document.getElementById('checkout-cod-btn').addEventListener('click', handleCheckout);
            document.getElementById('checkout-qr-btn').addEventListener('click', handleShowQR);
            document.getElementById('qr-paid-btn').addEventListener('click', handleCheckout);
            
            // 9. G√°n s·ª± ki·ªán ƒê√≥ng Modal
            document.body.addEventListener('click', (e) => {
                 if (e.target.classList.contains('close-modal')) {
                    const modalId = e.target.dataset.modal;
                    document.getElementById(modalId).style.display = 'none';
                }
                if (e.target.dataset.view === 'account-view') {
                    showView('account-view');
                    showTab('profile-tab'); 
                }
            });
            
            // 10. G√°n s·ª± ki·ªán cho Tabs (Chi ti·∫øt S·∫£n ph·∫©m)
            document.querySelector('.detail-tabs').addEventListener('click', (e) => {
                 if (e.target.classList.contains('detail-tab')) {
                    const tabId = e.target.dataset.tab;
                    showDetailTab(tabId);
                 }
            });
            
             // 11. G√°n s·ª± ki·ªán cho N√∫t ƒê√°nh gi√° (L·ªãch s·ª≠ ƒê∆°n h√†ng)
            document.getElementById('order-history-list').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-review-order')) {
                    const orderId = e.target.dataset.id;
                    openOrderReviewModal(orderId);
                }
            });
            
            // 12. G√°n s·ª± ki·ªán cho N√∫t Ch·ªçn SP ƒê√°nh gi√° (trong Modal)
            document.getElementById('review-order-products-list').addEventListener('click', (e) => {
                 if (e.target.classList.contains('btn-review-product')) {
                     const productId = e.target.dataset.id;
                     document.getElementById('review-order-modal').style.display = 'none';
                     openProductDetailModal(productId, { switchToReviewTab: true });
                 }
            });
            
            
            // (M·ªöI) 14. G√ÅN S·ª∞ KI·ªÜN CHO TAB "·∫¢NH ƒê√É TH·ª¨"
            document.getElementById('account-view').addEventListener('click', (e) => {
                if (e.target.classList.contains('btn-delete-tryon')) {
                    const filename = e.target.dataset.filename;
                    handleDeleteTryOnImage(filename);
                }
            });
        });
    </script>
</body>
</html>